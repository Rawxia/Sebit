<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sebit Lan Share</title>
  <link rel="icon" type="image/gif" href="favicon.gif">
  <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet"> <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet"> <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&display=swap" rel="stylesheet"> <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet"> <style>
    /* Base Styles - Default (Vaporwave-inspired) */
    body, html {
      margin: 0; padding: 0; overflow: hidden;
      font-family: 'Press Start 2P', monospace; color: #fff;
      image-rendering: pixelated;
      height: 100%;
      position: relative;
    }
    body {
      background: url('sebit background.gif') no-repeat center center;
      background-size: cover;
      animation: ocean 8s linear infinite;
    }

    @media (max-width: 768px) {
      body {
        background: url('sebit background.gif') no-repeat center center;
        background-size: cover;
      }
    }

    @keyframes ocean {
      0% { background-position: 0% 0; }
      100% { background-position: 100% 0; }
    }
    .title {
      position: absolute; top: 20px; width: 100%; text-align: center;
      font-size: 18px; color: #ff77ff; text-shadow: 2px 2px #77ffff;
      z-index: 10;
    }
    .welcome {
      position: absolute; top: 60px; width: 100%; text-align: center;
      font-size: 12px; color: #77ffff; text-shadow: 1px 1px #ff77ff;
      z-index: 10;
    }
    .bubble {
      position: absolute; width: 32px; height: 32px;
      background: url('minecraft-bubble.png') no-repeat center/contain;
      image-rendering: pixelated;
      animation: floatUp 8s linear infinite;
      cursor: pointer;
      z-index: 5;
    }
    @keyframes floatUp {
      0% { transform: translateY(100vh) scale(1); opacity: 0.8; }
      100% { transform: translateY(-20vh) scale(1.2); opacity: 0.6; }
    }
    .footer {
      position: absolute; bottom: 10px; width: 100%; text-align: center;
      font-size: 10px; color: #ccc; text-shadow: 0 0 4px #000;
      z-index: 10;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
    }
    .social-links {
      display: flex;
      gap: 15px;
      margin-top: 5px;
    }
    .social-links a {
      color: #77ffff;
      text-decoration: none;
      font-size: 12px;
      text-shadow: 1px 1px #ff77ff;
      transition: color 0.2s ease, text-shadow 0.2s ease;
    }
    .social-links a:hover {
      color: #ff77ff;
      text-shadow: 1px 1px #77ffff, 2px 2px #ff00ff;
    }

    /* Keep fileInput hidden */
    #fileInput { display: none; }

    /* Main UI elements default styles */
    .overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex; justify-content: center; align-items: center;
      flex-direction: column;
      z-index: 20;
      display: none; /* Ensure this is hidden by default */
    }
    .code-input, .message {
      background: #333; border: 2px solid #77ffff;
      padding: 10px; margin: 10px;
      font-family: 'Press Start 2P', monospace; color: #ff77ff;
      font-size: 16px; text-align: center;
      box-shadow: 0 0 10px rgba(119, 255, 255, 0.5);
      outline: none;
      width: 200px;
      max-width: 80%;
    }
    .btn {
      background: #007bff; border: 2px solid #0056b3;
      padding: 10px 20px; margin: 5px;
      font-family: 'Press Start 2P', monospace; color: #fff;
      font-size: 14px; cursor: pointer;
      box-shadow: 2px 2px #0056b3;
      transition: all 0.1s ease;
      text-decoration: none;
    }
    .btn:hover {
      background: #0056b3;
      box-shadow: 1px 1px #007bff;
      transform: translateY(1px) translateX(1px);
    }
    .status-message {
        position: absolute; top: 100px; width: 100%; text-align: center;
        font-size: 10px; color: #0f0; text-shadow: 1px 1px #000;
        z-index: 15;
    }

    #splashScreen {
      position: fixed; top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: #000;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      z-index: 999;
      opacity: 1;
      transition: opacity 2s ease-out;
      pointer-events: all;
      box-shadow: inset 0 0 10px 5px rgba(255, 255, 255, 0.1);
    }
    #splashScreen.fade-out {
      opacity: 0;
      pointer-events: none;
    }
    .splash-text {
      color: #ff00ff; font-size: 20px; text-align: center;
      text-shadow: 2px 2px #00ffff, 4px 4px #0000ff;
      margin-bottom: 20px;
      animation: text-flicker 0.8s infinite alternate;
      padding: 10px;
      border: 2px dashed #ff77ff;
      box-shadow: 0 0 15px rgba(255, 119, 255, 0.7);
    }
    .splash-subtext {
      color: #00ffff; font-size: 12px; text-align: center;
      text-shadow: 1px 1px #ff00ff;
      animation: pulse 2s infinite alternate;
      margin-bottom: 20px;
    }

    /* Updated How-To Styles */
    .how-to-use {
      background: rgba(0, 0, 0, 0.8);
      border: 2px solid #00ffff;
      padding: 20px;
      margin: 20px auto;
      font-size: 11px;
      color: #77ffff;
      text-shadow: 1px 1px #ff00ff;
      max-width: 450px;
      text-align: left;
      line-height: 1.6;
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
      border-radius: 8px;
    }
    .how-to-use h3 {
      text-align: center;
      color: #ff77ff;
      text-shadow: 1px 1px #00ffff;
      margin-top: 0;
      margin-bottom: 15px;
      font-size: 14px;
    }
    .how-to-use ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .how-to-use li {
      margin-bottom: 10px;
    }
    .how-to-use li::before {
      content: "• ";
      color: #ff77ff;
      font-weight: bold;
      display: inline-block;
      width: 1em;
      margin-left: -1em;
    }
    .how-to-use p {
        text-align: center;
        margin-top: 15px;
        font-style: italic;
        font-size: 10px;
    }

    /* Theme Selector styles */
    .theme-selector-container {
      margin-bottom: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }
    .theme-selector-container label {
      font-size: 12px;
      color: #77ffff;
      text-shadow: 1px 1px #ff77ff;
    }
    #themeSelect {
      background: #333;
      border: 2px solid #77ffff;
      padding: 8px 12px;
      font-family: 'Press Start 2P', monospace;
      color: #ff77ff;
      font-size: 12px;
      outline: none;
      box-shadow: 0 0 8px rgba(119, 255, 255, 0.5);
      cursor: pointer;
    }
    #themeSelect option {
      background: #333;
      color: #ff77ff;
    }


    @keyframes text-flicker {
      0% { opacity: 1; text-shadow: 2px 2px #00ffff, 4px 4px #0000ff; }
      50% { opacity: 0.9; text-shadow: 2px 2px #00ffff, 3px 3px #0000ff; }
      100% { opacity: 1; text-shadow: 2px 2px #00ffff, 4px 4px #0000ff; }
    }
    @keyframes pulse {
      0% { transform: scale(1); opacity: 0.8; }
      100% { transform: scale(1.03); opacity: 1; }
    }
    #splashScreen::before {
      content: '';
      position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      background: repeating-linear-gradient(
        #00000000 0px, #00000000 1px, rgba(0,0,0,0.1) 1px, rgba(0,0,0,0.1) 2px
      );
      pointer-events: none;
      z-index: 1;
    }

    #dropZoneOverlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 100, 200, 0.5);
      border: 4px dashed #77ffff;
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: #fff;
      font-size: 24px;
      text-shadow: 2px 2px #000;
      z-index: 998;
      pointer-events: none;
    }
    #dropZoneOverlay.active {
      display: flex;
      pointer-events: all;
    }
    #dropZoneOverlay .message {
      font-size: 18px;
      border: none;
      background: none;
      box-shadow: none;
      margin: 0; padding: 0;
    }

    #dropZoneOverlay .message .small-text {
        font-size: 14px;
        margin-top: 10px;
    }

    #progressBarContainer {
      position: absolute;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      width: 80%;
      max-width: 400px;
      background: #333;
      border: 2px solid #77ffff;
      box-shadow: 0 0 10px rgba(119, 255, 255, 0.5);
      display: none;
      overflow: hidden;
      z-index: 10;
    }
    #progressBar {
      height: 20px;
      width: 0%;
      background: linear-gradient(90deg, #0f0, #00a000);
      transition: width 0.1s linear;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 10px;
      color: #000;
      text-shadow: 1px 1px #0f0;
    }
    #progressBarContainer.active {
        display: block;
    }

    .confetti {
      position: absolute;
      width: 10px; height: 10px;
      background-color: #ffeb3b;
      opacity: 0;
      animation: confetti-fall 3s ease-out forwards;
      pointer-events: none;
      z-index: 100;
    }
    .confetti:nth-child(2n) { background-color: #ff4081; }
    .confetti:nth-child(3n) { background-color: #00e5ff; }
    .confetti:nth-child(4n) { background-color: #7c4dff; }
    @keyframes confetti-fall {
      0% { transform: translate(var(--x), var(--y)) rotate(0deg); opacity: 1; }
      100% { transform: translate(var(--x), 100vh) rotate(720deg); opacity: 0; }
    }

    #shibaContainer {
      position: absolute;
      top: 50%;
      left: 0;
      transform: translateY(-50%);
      display: none;
      flex-direction: column;
      align-items: center;
      z-index: 8;
      animation: shiba-float 10s ease-in-out infinite alternate;
      padding: 10px;
    }
    #shibaContainer.active {
      display: flex;
    }

    #shibaImage {
      width: 64px;
      height: 64px;
      image-rendering: pixelated;
      margin-bottom: 5px;
      filter: drop-shadow(2px 2px 0px #000);
    }

    #shibaText {
      background: rgba(0, 0, 0, 0.7);
      border: 2px solid #ff77ff;
      padding: 5px 10px;
      font-size: 10px;
      color: #77ffff;
      text-shadow: 1px 1px #ff00ff;
      white-space: nowrap;
      animation: text-flicker 1s infinite alternate;
    }

    @keyframes shiba-float {
      0% { transform: translate(0, -50%); }
      25% { transform: translate(10vw, -45%); }
      50% { transform: translate(20vw, -50%); }
      75% { transform: translate(10vw, -55%); }
      100% { transform: translate(0, -50%); }
    }

    .id-display {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    #myPeerId {
      font-size: 18px;
      color: #00ffcc;
      text-shadow: 1px 1px #000;
      background: rgba(0, 0, 0, 0.5);
      padding: 5px 10px;
      border: 1px solid #00ffcc;
      word-break: break-all;
    }

    #copyIdBtn {
        background: #00aaff;
        border: 2px solid #0077cc;
        padding: 8px 15px;
        font-size: 12px;
        color: #fff;
        cursor: pointer;
        box-shadow: 2px 2px #0077cc;
        transition: all 0.1s ease;
        white-space: nowrap;
    }

    #copyIdBtn:hover {
        background: #0077cc;
        box-shadow: 1px 1px #00aaff;
        transform: translateY(1px) translateX(1px);
    }

    /* Style for the "Ready!" button */
    #readyButton {
        margin-top: 30px;
        background: #28a745;
        border: 2px solid #1e7e34;
        padding: 15px 30px;
        font-size: 18px;
        color: #fff;
        cursor: pointer;
        box-shadow: 3px 3px #1e7e34;
        transition: all 0.1s ease;
        font-family: 'Press Start 2P', monospace;
    }

    #readyButton:hover {
        background: #1e7e34;
        box-shadow: 2px 2px #28a745;
        transform: translateY(1px) translateX(1px);
    }

    /* Styles for the emoji paperclip button - moved up and refined */
    #paperclipButtonContainer {
        position: fixed;
        top: 35%; /* Adjusted to be higher up */
        left: 50%;
        transform: translate(-50%, -50%);
        display: none; /* Hidden by default */
        flex-direction: column;
        align-items: center;
        z-index: 50;
    }

    #paperclipButton {
        background: rgba(0, 0, 0, 0.7);
        border: 2px solid #77ffff;
        padding: 10px;
        cursor: pointer;
        transition: transform 0.1s ease, box-shadow 0.1s ease;
        box-shadow: 4px 4px #000;
        border-radius: 5px;
        color: #fff;
        font-size: 48px;
        line-height: 1;
        user-select: none;
        text-align: center;
        display: flex; /* Use flexbox for vertical alignment of emoji */
        justify-content: center;
        align-items: center;
        width: 68px; /* Fixed width to make it square */
        height: 68px; /* Fixed height to make it square */
        margin-bottom: 8px; /* Space between button and text */
        filter: drop-shadow(2px 2px 0px rgba(0, 0, 0, 0.5)); /* Cleaner shadow for the emoji */
    }

    #paperclipButton:hover {
        transform: scale(1.1); /* Only scale, no translate here */
        box-shadow: 2px 2px #000;
    }

    #paperclipText {
        font-size: 10px;
        color: #77ffff;
        text-shadow: 1px 1px #ff00ff;
        text-align: center;
        background: rgba(0, 0, 0, 0.6);
        padding: 4px 8px;
        border-radius: 3px;
        white-space: nowrap;
        border: 1px solid #77ffff;
    }

    /* Styles for the new text input/output area */
    #textTransferContainer {
      position: fixed;
      bottom: 120px; /* Adjust based on footer and progress bar */
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      max-width: 500px;
      display: none; /* Hidden by default */
      flex-direction: column;
      gap: 10px;
      z-index: 50;
    }

    #textInput {
      width: calc(100% - 24px); /* Account for padding and border */
      height: 80px;
      background: #333;
      border: 2px solid #77ffff;
      padding: 10px;
      font-family: 'Press Start 2P', monospace;
      color: #ff77ff;
      font-size: 12px;
      resize: vertical; /* Allow vertical resizing */
      box-shadow: 0 0 10px rgba(119, 255, 255, 0.5);
      outline: none;
    }

    #sendTextBtn {
      background: #00aaff;
      border: 2px solid #0077cc;
      padding: 8px 15px;
      font-size: 12px;
      color: #fff;
      cursor: pointer;
      box-shadow: 2px 2px #0077cc;
      transition: all 0.1s ease;
      font-family: 'Press Start 2P', monospace;
      align-self: flex-end; /* Align to the right */
    }

    #sendTextBtn:hover {
      background: #0077cc;
      box-shadow: 1px 1px #00aaff;
      transform: translateY(1px) translateX(1px);
    }

    #receivedTextDisplay {
      background: rgba(0, 0, 0, 0.8);
      border: 2px solid #ff77ff;
      padding: 10px;
      font-family: 'Press Start 2P', monospace;
      color: #77ffff;
      font-size: 12px;
      white-space: pre-wrap; /* Preserves whitespace and wraps text */
      word-wrap: break-word; /* Breaks long words if necessary */
      max-height: 150px; /* Limit height and add scroll if needed */
      overflow-y: auto;
      box-shadow: 0 0 10px rgba(255, 119, 255, 0.5);
      margin-top: 10px; /* Space between input and output */
      display: none; /* Hidden by default, show when text received */
    }

    /* Additional style for paste button */
    #pasteIdBtn {
        background: #ffc107; /* A distinct color for paste */
        border: 2px solid #e0a800;
        padding: 10px 20px;
        font-size: 14px;
        color: #333; /* Darker text for contrast */
        cursor: pointer;
        box-shadow: 2px 2px #e0a800;
        transition: all 0.1s ease;
        white-space: nowrap;
    }

    #pasteIdBtn:hover {
        background: #e0a800;
        box-shadow: 1px 1px #ffc107;
        transform: translateY(1px) translateX(1px);
    }


    /* --- THEME STYLES --- */

    /* Theme: Computer Guy (Matrix) */
    .theme-computer-guy body {
      background: #000; /* Solid black background */
      animation: none; /* Disable ocean animation */
      font-family: 'VT323', monospace;
    }
    .theme-computer-guy #splashScreen {
      background: #000;
      box-shadow: none;
      border: none;
    }
    .theme-computer-guy .splash-text,
    .theme-computer-guy .splash-subtext {
      color: #0a0; /* Darker green text */
      text-shadow: 0 0 3px rgba(0, 170, 0, 0.7), 0 0 8px rgba(0, 170, 0, 0.5);
      border-color: #080;
      box-shadow: 0 0 10px rgba(0, 170, 0, 0.7);
    }
    .theme-computer-guy .how-to-use {
      background: rgba(0, 0, 0, 0.9);
      border: 2px solid #0a0;
      color: #0a0;
      text-shadow: 0 0 3px rgba(0, 170, 0, 0.5);
      box-shadow: 0 0 15px rgba(0, 170, 0, 0.5);
    }
    .theme-computer-guy .how-to-use h3 {
      color: #0f0;
      text-shadow: 0 0 5px rgba(0, 255, 0, 0.7);
    }
    .theme-computer-guy .how-to-use li::before {
      color: #0a0;
    }
    .theme-computer-guy #readyButton,
    .theme-computer-guy #themeSelect,
    .theme-computer-guy .theme-selector-container label {
      background: #020;
      border: 2px solid #080;
      color: #0f0;
      text-shadow: 0 0 5px rgba(0, 255, 0, 0.7);
      box-shadow: 0 0 8px rgba(0, 255, 0, 0.7);
    }
    .theme-computer-guy #readyButton:hover,
    .theme-computer-guy #themeSelect:hover {
      background: #0f0;
      color: #000;
      box-shadow: 0 0 12px rgba(0, 255, 0, 0.8);
    }
    /* Apply to main UI elements */
    .theme-computer-guy .title, .theme-computer-guy .welcome, .theme-computer-guy .footer {
        color: #0f0;
        text-shadow: 0 0 5px rgba(0, 255, 0, 0.7);
        font-family: 'VT323', monospace;
    }
    .theme-computer-guy .status-message {
        color: #0f0;
        text-shadow: 0 0 5px rgba(0, 255, 0, 0.7);
        background: rgba(0, 0, 0, 0.8);
        border-bottom: 1px solid #0f0;
        padding: 5px 0;
    }
    .theme-computer-guy .overlay {
        background: rgba(0, 0, 0, 0.9);
        border: 2px solid #0a0;
        box-shadow: 0 0 15px rgba(0, 170, 0, 0.7);
    }
    .theme-computer-guy .code-input, .theme-computer-guy #myPeerId, .theme-computer-guy #shibaText,
    .theme-computer-guy #textInput, .theme-computer-guy #receivedTextDisplay {
        background: #010;
        border: 2px solid #0a0;
        color: #0f0;
        box-shadow: 0 0 8px rgba(0, 170, 0, 0.5);
        font-family: 'VT323', monospace;
    }
    .theme-computer-guy .btn, .theme-computer-guy #copyIdBtn, .theme-computer-guy #pasteIdBtn, .theme-computer-guy #sendTextBtn,
    .theme-computer-guy #paperclipButton {
        background: #020;
        border: 2px solid #080;
        color: #0f0;
        box-shadow: 0 0 8px rgba(0, 255, 0, 0.5);
        font-family: 'VT323', monospace;
    }
    .theme-computer-guy .btn:hover, .theme-computer-guy #copyIdBtn:hover, .theme-computer-guy #pasteIdBtn:hover,
    .theme-computer-guy #sendTextBtn:hover, .theme-computer-guy #paperclipButton:hover {
        background: #0f0;
        color: #000;
        box-shadow: 0 0 12px rgba(0, 255, 0, 0.8);
    }
    .theme-computer-guy #progressBarContainer {
        border-color: #0a0;
        box-shadow: 0 0 10px rgba(0, 170, 0, 0.5);
    }
    .theme-computer-guy #progressBar {
        background: linear-gradient(90deg, #070, #0a0);
        color: #000;
        text-shadow: 1px 1px #0f0;
    }
    .theme-computer-guy #shibaText {
        border-color: #0a0;
        text-shadow: 0 0 5px rgba(0, 170, 0, 0.7);
        background: rgba(0, 0, 0, 0.8);
    }
    .theme-computer-guy #paperclipText {
        color: #0f0;
        text-shadow: 0 0 5px rgba(0, 255, 0, 0.7);
        border-color: #0a0;
        background: rgba(0, 0, 0, 0.7);
    }
    .theme-computer-guy #dropZoneOverlay {
        border-color: #0a0;
        background: rgba(0, 50, 0, 0.5);
        color: #0f0;
        text-shadow: 1px 1px #000;
    }
    /* Matrix rain effect */
    .theme-computer-guy body::after,
    .theme-computer-guy #splashScreen::after {
        content: "";
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><text x="0" y="15" font-family="monospace" font-size="16" fill="%230a0" opacity="0.8">010101</text><text x="0" y="35" font-family="monospace" font-size="16" fill="%230a0" opacity="0.8">101010</text><text x="0" y="55" font-family="monospace" font-size="16" fill="%230a0" opacity="0.8">001100</text><text x="0" y="75" font-family="monospace" font-size="16" fill="%230a0" opacity="0.8">110011</text><text x="0" y="95" font-family="monospace" font-size="16" fill="%230a0" opacity="0.8">010101</text></svg>') repeat;
        animation: matrix-rain 5s linear infinite;
        pointer-events: none;
        z-index: -1;
    }
    @keyframes matrix-rain {
        from { background-position: 0 0; }
        to { background-position: 0 100%; }
    }


    /* Theme: Gas (Steam Green) */
    .theme-gas body {
      background-color: #171d25; /* Dark bluish-grey */
      animation: none;
      font-family: Arial, sans-serif; /* A more traditional font */
    }
    .theme-gas .title, .theme-gas .welcome, .theme-gas .footer {
        color: #66c0f4;
        text-shadow: 1px 1px #000;
        font-family: Arial, sans-serif;
    }
    .theme-gas #splashScreen {
      background-color: #1a202c;
      border: 2px solid #66c0f4; /* Steam blue */
      box-shadow: 0 0 20px rgba(102, 192, 244, 0.5);
    }
    .theme-gas .splash-text {
      color: #66c0f4; /* Steam blue */
      text-shadow: 2px 2px #000, 4px 4px #000;
      border-color: #4a6c8d; /* Darker blue-grey */
      box-shadow: 0 0 15px rgba(102, 192, 244, 0.7);
    }
    .theme-gas .splash-subtext {
      color: #d1d1d1; /* Light grey */
      text-shadow: 1px 1px #000;
    }
    .theme-gas .how-to-use {
      background: #2a313c; /* Mid-dark blue-grey */
      border: 2px solid #4a6c8d;
      color: #d1d1d1;
      text-shadow: 1px 1px #000;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
    }
    .theme-gas .how-to-use h3 {
      color: #66c0f4;
      text-shadow: 1px 1px #000;
    }
    .theme-gas .how-to-use li::before {
      color: #66c0f4;
    }
    .theme-gas #readyButton,
    .theme-gas #themeSelect {
      background: linear-gradient(to bottom, #417a9b 5%, #2b556c 100%); /* Blue gradient */
      border: 2px solid #2a475e;
      color: #fff;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
      text-shadow: 1px 1px #000;
      font-family: Arial, sans-serif;
    }
    .theme-gas #readyButton:hover,
    .theme-gas #themeSelect:hover {
      background: linear-gradient(to bottom, #2b556c 5%, #417a9b 100%);
    }
    .theme-gas .theme-selector-container label {
      color: #d1d1d1;
      text-shadow: 1px 1px #000;
    }
    /* Apply to main UI elements */
    .theme-gas .overlay {
        background: rgba(26, 32, 44, 0.9);
        border: 2px solid #4a6c8d;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.7);
    }
    .theme-gas .code-input, .theme-gas #myPeerId, .theme-gas #shibaText,
    .theme-gas #textInput, .theme-gas #receivedTextDisplay {
        background: #2a313c;
        border: 2px solid #4a6c8d;
        color: #d1d1d1;
        box-shadow: inset 0 0 5px rgba(0,0,0,0.3);
        font-family: Arial, sans-serif;
    }
    .theme-gas .btn, .theme-gas #copyIdBtn, .theme-gas #pasteIdBtn, .theme-gas #sendTextBtn,
    .theme-gas #paperclipButton {
        background: linear-gradient(to bottom, #417a9b 5%, #2b556c 100%);
        border: 2px solid #2a475e;
        color: #fff;
        box-shadow: 2px 2px #000;
        text-shadow: 1px 1px #000;
        font-family: Arial, sans-serif;
    }
    .theme-gas .btn:hover, .theme-gas #copyIdBtn:hover, .theme-gas #pasteIdBtn:hover,
    .theme-gas #sendTextBtn:hover, .theme-gas #paperclipButton:hover {
        background: linear-gradient(to bottom, #2b556c 5%, #417a9b 100%);
        box-shadow: 1px 1px #000;
        transform: translateY(1px) translateX(1px);
    }
    .theme-gas #progressBarContainer {
        border-color: #4a6c8d;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
    }
    .theme-gas #progressBar {
        background: linear-gradient(90deg, #5185a8, #66c0f4);
        color: #1a202c;
        text-shadow: none;
    }
    .theme-gas #shibaText {
        border-color: #4a6c8d;
        color: #d1d1d1;
        text-shadow: 1px 1px #000;
    }
    .theme-gas #paperclipText {
        color: #d1d1d1;
        text-shadow: 1px 1px #000;
        border-color: #4a6c8d;
        background: rgba(26, 32, 44, 0.6);
    }
    .theme-gas #dropZoneOverlay {
        border-color: #66c0f4;
        background: rgba(26, 32, 44, 0.7);
        color: #66c0f4;
        text-shadow: 1px 1px #000;
    }


    /* Theme: Neon (Black and Orange) */
    .theme-neon body {
      background-color: #000;
      animation: none;
    }
    .theme-neon .title, .theme-neon .welcome, .theme-neon .footer {
        color: #ff6600;
        text-shadow: 0 0 5px #ff6600, 0 0 15px #ff6600;
    }
    .theme-neon #splashScreen {
      background-color: #000;
      box-shadow: inset 0 0 15px 5px rgba(255, 100, 0, 0.3);
      border: 2px solid #ff6600;
    }
    .theme-neon .splash-text,
    .theme-neon .splash-subtext {
      color: #ff6600; /* Orange */
      text-shadow: 0 0 5px #ff6600, 0 0 15px #ff6600;
      border-color: #ff6600;
      box-shadow: 0 0 20px rgba(255, 100, 0, 0.7);
      animation: neon-glow 1.5s infinite alternate;
    }
    .theme-neon .how-to-use {
      background: rgba(0, 0, 0, 0.9);
      border: 2px solid #ff6600;
      color: #ffaa00;
      text-shadow: 0 0 5px rgba(255, 170, 0, 0.5);
      box-shadow: 0 0 20px rgba(255, 100, 0, 0.5);
    }
    .theme-neon .how-to-use h3 {
      color: #ff6600;
      text-shadow: 0 0 5px #ff6600;
    }
    .theme-neon .how-to-use li::before {
      color: #ff6600;
    }
    .theme-neon #readyButton,
    .theme-neon #themeSelect,
    .theme-neon .theme-selector-container label {
      background: #331a00; /* Dark orange background */
      border: 2px solid #ff6600;
      color: #ff6600;
      text-shadow: 0 0 5px #ff6600;
      box-shadow: 0 0 10px rgba(255, 100, 0, 0.7);
    }
    .theme-neon #readyButton:hover,
    .theme-neon #themeSelect:hover {
      background: #ff6600;
      color: #000;
      box-shadow: 0 0 15px rgba(255, 100, 0, 1);
    }
    @keyframes neon-glow {
      from { text-shadow: 0 0 5px #ff6600, 0 0 15px #ff6600, 0 0 25px #ff6600; }
      to { text-shadow: 0 0 10px #ff6600, 0 0 20px #ff6600, 0 0 30px #ff6600; }
    }
    /* Apply to main UI elements */
    .theme-neon .status-message {
        color: #ff6600;
        text-shadow: 0 0 5px #ff6600;
        background: rgba(0, 0, 0, 0.8);
        border-bottom: 1px solid #ff6600;
        padding: 5px 0;
    }
    .theme-neon .overlay {
        background: rgba(0, 0, 0, 0.9);
        border: 2px solid #ff6600;
        box-shadow: 0 0 15px rgba(255, 100, 0, 0.7);
    }
    .theme-neon .code-input, .theme-neon #myPeerId, .theme-neon #shibaText,
    .theme-neon #textInput, .theme-neon #receivedTextDisplay {
        background: #1a0000;
        border: 2px solid #ff6600;
        color: #ff6600;
        box-shadow: 0 0 8px rgba(255, 100, 0, 0.5);
    }
    .theme-neon .btn, .theme-neon #copyIdBtn, .theme-neon #pasteIdBtn, .theme-neon #sendTextBtn,
    .theme-neon #paperclipButton {
        background: #331a00;
        border: 2px solid #ff6600;
        color: #ff6600;
        box-shadow: 0 0 8px rgba(255, 100, 0, 0.5);
    }
    .theme-neon .btn:hover, .theme-neon #copyIdBtn:hover, .theme-neon #pasteIdBtn:hover,
    .theme-neon #sendTextBtn:hover, .theme-neon #paperclipButton:hover {
        background: #ff6600;
        color: #000;
        box-shadow: 0 0 12px rgba(255, 100, 0, 0.8);
    }
    .theme-neon #progressBarContainer {
        border-color: #ff6600;
        box-shadow: 0 0 10px rgba(255, 100, 0, 0.5);
    }
    .theme-neon #progressBar {
        background: linear-gradient(90deg, #ff9900, #ff6600);
        color: #000;
        text-shadow: none;
    }
    .theme-neon #shibaText {
        border-color: #ff6600;
        text-shadow: 0 0 5px #ff6600;
    }
    .theme-neon #paperclipText {
        color: #ff6600;
        text-shadow: 0 0 5px #ff6600;
        border-color: #ff6600;
        background: rgba(0, 0, 0, 0.7);
    }
    .theme-neon #dropZoneOverlay {
        border-color: #ff6600;
        background: rgba(255, 100, 0, 0.5);
        color: #ff6600;
        text-shadow: 1px 1px #000;
    }

    /* Theme: Nostalgia (Windows XP) */
    .theme-nostalgia-xp body {
      background: #3a6ea5; /* XP Blue */
      animation: none;
      font-family: 'Segoe UI', Arial, sans-serif; /* Cleaner font for XP feel */
    }
    .theme-nostalgia-xp .title, .theme-nostalgia-xp .welcome, .theme-nostalgia-xp .footer {
        color: #fff;
        text-shadow: 1px 1px #000;
        font-family: 'Segoe UI', Arial, sans-serif;
    }
    .theme-nostalgia-xp #splashScreen {
      background: linear-gradient(to bottom, #0a246a 0%, #1e5799 100%); /* XP Gradient */
      border: 1px solid #003366;
      box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.5);
      color: #fff;
    }
    .theme-nostalgia-xp .splash-text {
      color: #fff;
      font-family: 'Segoe UI', sans-serif; /* Cleaner font for XP feel */
      text-shadow: 1px 1px #000;
      border-color: #9ac2ff;
      box-shadow: inset 0 0 5px rgba(255,255,255,0.3), 0 0 10px rgba(0, 51, 102, 0.5);
      animation: none; /* No flicker for XP */
    }
    .theme-nostalgia-xp .splash-subtext {
      color: #e0e0e0;
      text-shadow: 1px 1px #000;
      animation: none; /* No pulse for XP */
    }
    .theme-nostalgia-xp .how-to-use {
      background: #e9e9e9; /* Light grey dialog */
      border: 1px solid #7f9db9; /* Grey border */
      color: #000; /* Dark text */
      text-shadow: none;
      box-shadow: 3px 3px 8px rgba(0,0,0,0.3);
    }
    .theme-nostalgia-xp .how-to-use h3 {
      color: #0a246a; /* XP Dark Blue */
      text-shadow: none;
    }
    .theme-nostalgia-xp .how-to-use li::before {
      color: #0a246a;
    }
    .theme-nostalgia-xp #readyButton {
      background: linear-gradient(to bottom, #d6e8f8 0%, #a4c9e3 100%); /* XP Button gradient */
      border: 1px solid #5a87b7;
      color: #000;
      box-shadow: 1px 1px 3px rgba(0,0,0,0.3);
      font-family: 'Segoe UI', sans-serif;
    }
    .theme-nostalgia-xp #readyButton:hover {
      background: linear-gradient(to bottom, #a4c9e3 0%, #d6e8f8 100%);
    }
    .theme-nostalgia-xp #themeSelect {
      background: #e0e0e0;
      border: 1px solid #7f9db9;
      color: #000;
      box-shadow: inset 1px 1px 2px rgba(0,0,0,0.2);
      font-family: 'Segoe UI', sans-serif;
    }
    .theme-nostalgia-xp .theme-selector-container label {
      color: #fff;
      text-shadow: 1px 1px #000;
      font-family: 'Segoe UI', sans-serif;
    }
    /* Apply to main UI elements */
    .theme-nostalgia-xp .status-message {
        color: #fff;
        text-shadow: 1px 1px #000;
        background: rgba(0, 51, 102, 0.8);
        border-bottom: 1px solid #fff;
        padding: 5px 0;
    }
    .theme-nostalgia-xp .overlay {
        background: linear-gradient(to bottom, #0a246a 0%, #1e5799 100%);
        border: 1px solid #003366;
        box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.5);
    }
    .theme-nostalgia-xp .code-input, .theme-nostalgia-xp #myPeerId, .theme-nostalgia-xp #shibaText,
    .theme-nostalgia-xp #textInput, .theme-nostalgia-xp #receivedTextDisplay {
        background: #e0e0e0;
        border: 1px solid #7f9db9;
        color: #000;
        box-shadow: inset 1px 1px 2px rgba(0,0,0,0.2);
        font-family: 'Segoe UI', sans-serif;
    }
    .theme-nostalgia-xp .btn, .theme-nostalgia-xp #copyIdBtn, .theme-nostalgia-xp #pasteIdBtn,
    .theme-nostalgia-xp #sendTextBtn, .theme-nostalgia-xp #paperclipButton {
        background: linear-gradient(to bottom, #d6e8f8 0%, #a4c9e3 100%);
        border: 1px solid #5a87b7;
        color: #000;
        box-shadow: 1px 1px 3px rgba(0,0,0,0.3);
        font-family: 'Segoe UI', sans-serif;
    }
    .theme-nostalgia-xp .btn:hover, .theme-nostalgia-xp #copyIdBtn:hover, .theme-nostalgia-xp #pasteIdBtn:hover,
    .theme-nostalgia-xp #sendTextBtn:hover, .theme-nostalgia-xp #paperclipButton:hover {
        background: linear-gradient(to bottom, #a4c9e3 0%, #d6e8f8 100%);
        box-shadow: 0 0 2px rgba(0,0,0,0.2);
        transform: translateY(1px) translateX(1px);
    }
    .theme-nostalgia-xp #progressBarContainer {
        border-color: #5a87b7;
        box-shadow: 0 0 8px rgba(0,0,0,0.3);
    }
    .theme-nostalgia-xp #progressBar {
        background: linear-gradient(90deg, #5cb85c, #449d44); /* Green XP progress bar */
        color: #fff;
        text-shadow: 1px 1px #000;
    }
    .theme-nostalgia-xp #shibaText {
        border-color: #5a87b7;
        color: #000;
        text-shadow: none;
        background: #e0e0e0;
    }
    .theme-nostalgia-xp #paperclipText {
        color: #000;
        text-shadow: none;
        border-color: #5a87b7;
        background: #e0e0e0;
    }
    .theme-nostalgia-xp #dropZoneOverlay {
        border-color: #5a87b7;
        background: rgba(58, 110, 165, 0.7);
        color: #fff;
        text-shadow: 1px 1px #000;
    }


    /* Theme: Nostalgia (Windows Vista) */
    .theme-nostalgia-vista body {
      background: linear-gradient(to bottom, #0e2b4d 0%, #081a2f 100%); /* Vista background gradient */
      animation: none;
      font-family: 'Segoe UI', Arial, sans-serif; /* Vista font */
    }
    .theme-nostalgia-vista .title, .theme-nostalgia-vista .welcome, .theme-nostalgia-vista .footer {
        color: #c0e0ff;
        text-shadow: 0 0 5px rgba(192, 224, 255, 0.5);
        font-family: 'Segoe UI', Arial, sans-serif;
    }
    .theme-nostalgia-vista #splashScreen {
      background: radial-gradient(circle at center, rgba(30,39,52,0.9) 0%, rgba(10,13,17,0.95) 100%);
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 0 30px rgba(0,0,0,0.7);
      backdrop-filter: blur(5px); /* Aero Glass effect */
      -webkit-backdrop-filter: blur(5px);
    }
    .theme-nostalgia-vista .splash-text {
      color: #c0e0ff; /* Light blue */
      text-shadow: 0 0 8px rgba(192, 224, 255, 0.5), 0 0 15px rgba(192, 224, 255, 0.3);
      font-family: 'Segoe UI', sans-serif; /* Vista font */
      border-color: rgba(192, 224, 255, 0.3);
      box-shadow: inset 0 0 5px rgba(255,255,255,0.1), 0 0 20px rgba(192, 224, 255, 0.3);
      animation: none;
    }
    .theme-nostalgia-vista .splash-subtext {
      color: #a0c0ff;
      text-shadow: 0 0 5px rgba(160, 192, 255, 0.5);
      animation: none;
    }
    .theme-nostalgia-vista .how-to-use {
      background: rgba(30, 39, 52, 0.7); /* Translucent dark background */
      border: 1px solid rgba(192, 224, 255, 0.2);
      color: #c0e0ff;
      text-shadow: none;
      box-shadow: 0 0 15px rgba(0,0,0,0.5);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    .theme-nostalgia-vista .how-to-use h3 {
      color: #c0e0ff;
      text-shadow: 0 0 5px rgba(192, 224, 255, 0.5);
    }
    .theme-nostalgia-vista .how-to-use li::before {
      color: #c0e0ff;
    }
    .theme-nostalgia-vista #readyButton {
      background: linear-gradient(to bottom, #729fcf 0%, #4a75a7 100%); /* Vista Button Blue */
      border: 1px solid #36577e;
      color: #fff;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
      font-family: 'Segoe UI', sans-serif;
      text-shadow: 1px 1px #000;
    }
    .theme-nostalgia-vista #readyButton:hover {
      background: linear-gradient(to bottom, #4a75a7 0%, #729fcf 100%);
    }
    .theme-nostalgia-vista #themeSelect {
      background: rgba(30, 39, 52, 0.7);
      border: 1px solid rgba(192, 224, 255, 0.2);
      color: #c0e0ff;
      box-shadow: inset 0 0 5px rgba(0,0,0,0.2);
      font-family: 'Segoe UI', sans-serif;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
    }
    .theme-nostalgia-vista .theme-selector-container label {
      color: #c0e0ff;
      text-shadow: 0 0 5px rgba(192, 224, 255, 0.5);
      font-family: 'Segoe UI', sans-serif;
    }
    /* Apply to main UI elements */
    .theme-nostalgia-vista .status-message {
        color: #c0e0ff;
        text-shadow: 0 0 5px rgba(192, 224, 255, 0.5);
        background: rgba(14, 43, 77, 0.8);
        border-bottom: 1px solid rgba(192, 224, 255, 0.2);
        padding: 5px 0;
    }
    .theme-nostalgia-vista .overlay {
        background: radial-gradient(circle at center, rgba(30,39,52,0.9) 0%, rgba(10,13,17,0.95) 100%);
        border: 1px solid rgba(255,255,255,0.1);
        box-shadow: 0 0 30px rgba(0,0,0,0.7);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
    }
    .theme-nostalgia-vista .code-input, .theme-nostalgia-vista #myPeerId, .theme-nostalgia-vista #shibaText,
    .theme-nostalgia-vista #textInput, .theme-nostalgia-vista #receivedTextDisplay {
        background: rgba(30, 39, 52, 0.7);
        border: 1px solid rgba(192, 224, 255, 0.2);
        color: #c0e0ff;
        box-shadow: inset 0 0 5px rgba(0,0,0,0.2);
        font-family: 'Segoe UI', sans-serif;
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
    }
    .theme-nostalgia-vista .btn, .theme-nostalgia-vista #copyIdBtn, .theme-nostalgia-vista #pasteIdBtn,
    .theme-nostalgia-vista #sendTextBtn, .theme-nostalgia-vista #paperclipButton {
        background: linear-gradient(to bottom, #729fcf 0%, #4a75a7 100%);
        border: 1px solid #36577e;
        color: #fff;
        box-shadow: 0 0 10px rgba(0,0,0,0.5);
        font-family: 'Segoe UI', sans-serif;
        text-shadow: 1px 1px #000;
    }
    .theme-nostalgia-vista .btn:hover, .theme-nostalgia-vista #copyIdBtn:hover, .theme-nostalgia-vista #pasteIdBtn:hover,
    .theme-nostalgia-vista #sendTextBtn:hover, .theme-nostalgia-vista #paperclipButton:hover {
        background: linear-gradient(to bottom, #4a75a7 0%, #729fcf 100%);
        box-shadow: 0 0 5px rgba(0,0,0,0.5);
        transform: translateY(1px) translateX(1px);
    }
    .theme-nostalgia-vista #progressBarContainer {
        border-color: rgba(192, 224, 255, 0.2);
        box-shadow: 0 0 10px rgba(0,0,0,0.5);
    }
    .theme-nostalgia-vista #progressBar {
        background: linear-gradient(90deg, #32cd32, #008000); /* Green Vista progress bar */
        color: #fff;
        text-shadow: 1px 1px #000;
    }
    .theme-nostalgia-vista #shibaText {
        border-color: rgba(192, 224, 255, 0.2);
        color: #c0e0ff;
        text-shadow: 0 0 5px rgba(192, 224, 255, 0.5);
        background: rgba(30, 39, 52, 0.7);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
    }
    .theme-nostalgia-vista #paperclipText {
        color: #c0e0ff;
        text-shadow: 0 0 5px rgba(192, 224, 255, 0.5);
        border-color: rgba(192, 224, 255, 0.2);
        background: rgba(30, 39, 52, 0.7);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
    }
    .theme-nostalgia-vista #dropZoneOverlay {
        border-color: rgba(192, 224, 255, 0.2);
        background: rgba(14, 43, 77, 0.7);
        color: #c0e0ff;
        text-shadow: 0 0 5px rgba(192, 224, 255, 0.5);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
    }

    /* Theme: A Box 720 (Xbox 360) */
    .theme-a-box-720 body {
      background: radial-gradient(circle at center, #1C4600 0%, #080D00 100%); /* Dark green to black */
      animation: none;
      font-family: 'Segoe UI', Arial, sans-serif;
      color: #FFF;
    }
    .theme-a-box-720 .title, .theme-a-box-720 .welcome, .theme-a-box-720 .footer {
        color: #92FF1F; /* Xbox green */
        text-shadow: 0 0 5px rgba(146, 255, 31, 0.7);
        font-family: 'Segoe UI', Arial, sans-serif;
    }
    .theme-a-box-720 #splashScreen {
      background: radial-gradient(circle at center, #1C4600 0%, #080D00 100%);
      border: 2px solid #92FF1F; /* Xbox green border */
      box-shadow: 0 0 25px rgba(146, 255, 31, 0.7);
    }
    .theme-a-box-720 .splash-text {
      color: #92FF1F; /* Xbox green */
      text-shadow: 0 0 8px rgba(146, 255, 31, 0.7), 0 0 15px rgba(146, 255, 31, 0.5);
      border-color: #92FF1F;
      box-shadow: 0 0 20px rgba(146, 255, 31, 0.7);
      animation: xbox-glow 2s infinite alternate;
    }
    .theme-a-box-720 .splash-subtext {
      color: #DDEECC;
      text-shadow: 0 0 5px rgba(221, 238, 204, 0.5);
      animation: none;
    }
    .theme-a-box-720 .how-to-use {
      background: rgba(0, 0, 0, 0.8);
      border: 2px solid #92FF1F;
      color: #DDEECC;
      text-shadow: none;
      box-shadow: 0 0 20px rgba(146, 255, 31, 0.5);
    }
    .theme-a-box-720 .how-to-use h3 {
      color: #92FF1F;
      text-shadow: 0 0 5px rgba(146, 255, 31, 0.7);
    }
    .theme-a-box-720 .how-to-use li::before {
      color: #92FF1F;
    }
    .theme-a-box-720 #readyButton {
      background: linear-gradient(to bottom, #92FF1F 0%, #6BAA1C 100%); /* Green button */
      border: 2px solid #588716;
      color: #000;
      box-shadow: 3px 3px 8px rgba(0,0,0,0.5);
      font-family: 'Segoe UI', sans-serif;
      text-shadow: 1px 1px #FFF;
    }
    .theme-a-box-720 #readyButton:hover {
      background: linear-gradient(to bottom, #6BAA1C 0%, #92FF1F 100%);
    }
    .theme-a-box-720 #themeSelect {
      background: #080D00;
      border: 2px solid #92FF1F;
      color: #92FF1F;
      box-shadow: inset 0 0 5px rgba(146, 255, 31, 0.5);
      font-family: 'Segoe UI', sans-serif;
    }
    .theme-a-box-720 .theme-selector-container label {
      color: #92FF1F;
      text-shadow: 0 0 5px rgba(146, 255, 31, 0.7);
      font-family: 'Segoe UI', sans-serif;
    }
    @keyframes xbox-glow {
      from { text-shadow: 0 0 8px rgba(146, 255, 31, 0.7), 0 0 15px rgba(146, 255, 31, 0.5); }
      to { text-shadow: 0 0 12px rgba(146, 255, 31, 0.8), 0 0 20px rgba(146, 255, 31, 0.6); }
    }
    /* Apply to main UI elements */
    .theme-a-box-720 .status-message {
        color: #92FF1F;
        text-shadow: 0 0 5px rgba(146, 255, 31, 0.7);
        background: rgba(0, 0, 0, 0.8);
        border-bottom: 1px solid #92FF1F;
        padding: 5px 0;
    }
    .theme-a-box-720 .overlay {
        background: radial-gradient(circle at center, #1C4600 0%, #080D00 100%);
        border: 2px solid #92FF1F;
        box-shadow: 0 0 25px rgba(146, 255, 31, 0.7);
    }
    .theme-a-box-720 .code-input, .theme-a-box-720 #myPeerId, .theme-a-box-720 #shibaText,
    .theme-a-box-720 #textInput, .theme-a-box-720 #receivedTextDisplay {
        background: #0D1400;
        border: 2px solid #92FF1F;
        color: #92FF1F;
        box-shadow: inset 0 0 5px rgba(146, 255, 31, 0.5);
        font-family: 'Segoe UI', sans-serif;
    }
    .theme-a-box-720 .btn, .theme-a-box-720 #copyIdBtn, .theme-a-box-720 #pasteIdBtn,
    .theme-a-box-720 #sendTextBtn, .theme-a-box-720 #paperclipButton {
        background: linear-gradient(to bottom, #92FF1F 0%, #6BAA1C 100%);
        border: 2px solid #588716;
        color: #000;
        box-shadow: 2px 2px #000;
        text-shadow: 1px 1px #FFF;
        font-family: 'Segoe UI', sans-serif;
    }
    .theme-a-box-720 .btn:hover, .theme-a-box-720 #copyIdBtn:hover, .theme-a-box-720 #pasteIdBtn:hover,
    .theme-a-box-720 #sendTextBtn:hover, .theme-a-box-720 #paperclipButton:hover {
        background: linear-gradient(to bottom, #6BAA1C 0%, #92FF1F 100%);
        box-shadow: 1px 1px #000;
        transform: translateY(1px) translateX(1px);
    }
    .theme-a-box-720 #progressBarContainer {
        border-color: #92FF1F;
        box-shadow: 0 0 10px rgba(146, 255, 31, 0.7);
    }
    .theme-a-box-720 #progressBar {
        background: linear-gradient(90deg, #6BAA1C, #92FF1F);
        color: #000;
        text-shadow: 1px 1px #FFF;
    }
    .theme-a-box-720 #shibaText {
        border-color: #92FF1F;
        color: #92FF1F;
        text-shadow: 0 0 5px rgba(146, 255, 31, 0.7);
        background: #0D1400;
    }
    .theme-a-box-720 #paperclipText {
        color: #92FF1F;
        text-shadow: 0 0 5px rgba(146, 255, 31, 0.7);
        border-color: #92FF1F;
        background: rgba(0, 0, 0, 0.8);
    }
    .theme-a-box-720 #dropZoneOverlay {
        border-color: #92FF1F;
        background: rgba(28, 70, 0, 0.7);
        color: #92FF1F;
        text-shadow: 0 0 5px rgba(146, 255, 31, 0.7);
    }

    /* Theme: The Young Scrolls (Oblivion-inspired) */
    .theme-the-young-scrolls body {
      background-color: #d1c3a6; /* Parchment background */
      animation: none;
      font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, serif;
      color: #4e342e; /* Deep brown text */
    }
    .theme-the-young-scrolls .title, .theme-the-young-scrolls .welcome {
        color: #8b0000; /* Dark red */
        text-shadow: 1px 1px #a0875a; /* Muted gold shadow */
        font-family: 'Merriweather', serif; /* A more "scroll-like" font */
        font-weight: 700;
    }
    .theme-the-young-scrolls .footer {
        color: #4e342e;
        background-color: #c0b299; /* Darker parchment */
        padding: 5px;
        border-top: 1px solid #a0875a;
        text-shadow: none;
        font-family: Arial, sans-serif; /* Simpler font for footer */
    }
    .theme-the-young-scrolls .social-links a {
        color: #8b0000;
        text-shadow: 1px 1px #a0875a;
    }
    .theme-the-young-scrolls .social-links a:hover {
        color: #a0875a;
        text-shadow: 1px 1px #8b0000;
    }
    .theme-the-young-scrolls #splashScreen {
      background: #c0b299; /* Darker parchment */
      border: 5px double #a0875a; /* Muted gold double border */
      box-shadow: inset 0 0 20px rgba(0,0,0,0.5), 0 0 30px rgba(0,0,0,0.3);
    }
    .theme-the-young-scrolls .splash-text {
      color: #8b0000;
      text-shadow: 2px 2px #a0875a, 3px 3px #6f4e37; /* Gold and brown shadow */
      border-color: #a0875a;
      box-shadow: 0 0 15px rgba(160, 135, 90, 0.7);
      animation: none;
      font-family: 'Merriweather', serif;
      font-size: 24px;
      line-height: 1.2;
    }
    .theme-the-young-scrolls .splash-subtext {
      color: #4e342e;
      text-shadow: none;
      animation: none;
      font-family: Arial, sans-serif;
      font-size: 14px;
      font-style: italic;
    }
    .theme-the-young-scrolls .how-to-use {
      background: #fdfae6; /* Lighter parchment */
      border: 1px solid #6f4e37; /* Dark brown border */
      color: #4e342e;
      text-shadow: none;
      box-shadow: 5px 5px 10px rgba(0,0,0,0.2);
    }
    .theme-the-young-scrolls .how-to-use h3 {
      color: #8b0000;
      text-shadow: 1px 1px #a0875a;
      font-family: 'Merriweather', serif;
    }
    .theme-the-young-scrolls .how-to-use li::before {
      color: #8b0000;
    }
    .theme-the-young-scrolls #readyButton {
      background: linear-gradient(to bottom, #a0875a 0%, #6f4e37 100%); /* Gold to brown gradient */
      border: 2px outset #4e342e;
      color: #fff;
      text-shadow: 1px 1px #000;
      box-shadow: 3px 3px 5px rgba(0,0,0,0.3);
      font-family: 'Merriweather', serif;
    }
    .theme-the-young-scrolls #readyButton:hover {
      background: linear-gradient(to bottom, #6f4e37 0%, #a0875a 100%);
    }
    .theme-the-young-scrolls #themeSelect {
      background: #fdfae6;
      border: 1px solid #6f4e37;
      color: #4e342e;
      box-shadow: inset 1px 1px 3px rgba(0,0,0,0.2);
      font-family: Arial, sans-serif;
    }
    .theme-the-young-scrolls .theme-selector-container label {
      color: #8b0000;
      text-shadow: 1px 1px #a0875a;
      font-family: Arial, sans-serif;
    }
    /* Apply to main UI elements */
    .theme-the-young-scrolls .status-message {
        color: #8b0000;
        text-shadow: 1px 1px #a0875a;
        background: rgba(209, 195, 166, 0.8);
        border-bottom: 1px solid #a0875a;
        padding: 5px 0;
        font-family: Arial, sans-serif;
    }
    .theme-the-young-scrolls .overlay {
        background: rgba(209, 195, 166, 0.9);
        border: 2px solid #a0875a;
        box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }
    .theme-the-young-scrolls .code-input, .theme-the-young-scrolls #myPeerId, .theme-the-young-scrolls #shibaText,
    .theme-the-young-scrolls #textInput, .theme-the-young-scrolls #receivedTextDisplay {
        background: #fdfae6;
        border: 1px solid #6f4e37;
        color: #4e342e;
        box-shadow: inset 1px 1px 3px rgba(0,0,0,0.2);
        font-family: Arial, sans-serif;
    }
    .theme-the-young-scrolls .btn, .theme-the-young-scrolls #copyIdBtn, .theme-the-young-scrolls #pasteIdBtn,
    .theme-the-young-scrolls #sendTextBtn, .theme-the-young-scrolls #paperclipButton {
        background: linear-gradient(to bottom, #a0875a 0%, #6f4e37 100%);
        border: 2px outset #4e342e;
        color: #fff;
        text-shadow: 1px 1px #000;
        box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
        font-family: Arial, sans-serif;
    }
    .theme-the-young-scrolls .btn:hover, .theme-the-young-scrolls #copyIdBtn:hover, .theme-the-young-scrolls #pasteIdBtn:hover,
    .theme-the-young-scrolls #sendTextBtn:hover, .theme-the-young-scrolls #paperclipButton:hover {
        background: linear-gradient(to bottom, #6f4e37 0%, #a0875a 100%);
        box-shadow: 1px 1px 3px rgba(0,0,0,0.2);
        transform: translateY(1px) translateX(1px);
    }
    .theme-the-young-scrolls #progressBarContainer {
        border-color: #a0875a;
        box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }
    .theme-the-young-scrolls #progressBar {
        background: linear-gradient(90deg, #8b0000, #a0875a); /* Red to gold progress bar */
        color: #fff;
        text-shadow: 1px 1px #000;
    }
    .theme-the-young-scrolls #shibaText {
        border-color: #6f4e37;
        color: #4e342e;
        text-shadow: none;
        background: #fdfae6;
    }
    .theme-the-young-scrolls #paperclipText {
        color: #4e342e;
        text-shadow: none;
        border-color: #6f4e37;
        background: #fdfae6;
    }
    .theme-the-young-scrolls #dropZoneOverlay {
        border-color: #a0875a;
        background: rgba(209, 195, 166, 0.7);
        color: #4e342e;
        text-shadow: 1px 1px #a0875a;
    }

    /* Theme: Apples (macOS-inspired) */
    .theme-apples body {
        background: linear-gradient(to bottom, #f0f2f5, #e0e2e5); /* Light, subtle gradient */
        animation: none;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';
        color: #333; /* Soft dark grey */
    }
    .theme-apples .title, .theme-apples .welcome {
        color: #007aff; /* Apple blue */
        text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        font-weight: 500;
    }
    .theme-apples .footer {
        color: #666;
        background: rgba(255, 255, 255, 0.8);
        padding: 10px;
        border-top: 1px solid rgba(0,0,0,0.05);
        box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        text-shadow: none;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    }
    .theme-apples .social-links a {
        color: #007aff;
        text-shadow: none;
        font-weight: 400;
    }
    .theme-apples .social-links a:hover {
        color: #005bb5;
        text-shadow: none;
    }
    .theme-apples #splashScreen {
        background: linear-gradient(to bottom, #f8f8f8, #e8e8e8);
        box-shadow: 0 10px 30px rgba(0,0,0,0.1), inset 0 0 20px rgba(255,255,255,0.8);
        border: none;
    }
    .theme-apples .splash-text {
        color: #333;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        font-weight: 700;
        font-size: 24px;
        text-shadow: none;
        border: none;
        box-shadow: none;
        animation: none;
        padding: 0;
    }
    .theme-apples .splash-subtext {
        color: #666;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        font-size: 14px;
        text-shadow: none;
        animation: none;
    }
    .theme-apples .how-to-use {
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(0,0,0,0.1);
        color: #333;
        text-shadow: none;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        border-radius: 12px;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
    }
    .theme-apples .how-to-use h3 {
        color: #007aff;
        text-shadow: none;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    }
    .theme-apples .how-to-use li::before {
        color: #007aff;
    }
    .theme-apples #readyButton {
        background: linear-gradient(to bottom, #007aff 0%, #005bb5 100%);
        border: none;
        border-radius: 8px;
        color: #fff;
        text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        font-weight: 500;
    }
    .theme-apples #readyButton:hover {
        background: linear-gradient(to bottom, #005bb5 0%, #007aff 100%);
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        transform: translateY(1px);
    }
    .theme-apples #themeSelect {
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 8px;
        color: #333;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        padding: 6px 10px;
    }
    .theme-apples .theme-selector-container label {
        color: #333;
        text-shadow: none;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    }
    /* Apply to main UI elements */
    .theme-apples .status-message {
        color: #007aff;
        text-shadow: none;
        background: rgba(255, 255, 255, 0.8);
        border-bottom: 1px solid rgba(0,0,0,0.1);
        padding: 5px 0;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    }
    .theme-apples .overlay {
        background: rgba(255, 255, 255, 0.9);
        border: none;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        border-radius: 15px;
    }
    .theme-apples .code-input, .theme-apples #myPeerId, .theme-apples #shibaText,
    .theme-apples #textInput, .theme-apples #receivedTextDisplay {
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 8px;
        color: #333;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        padding: 8px 10px;
    }
    .theme-apples .btn, .theme-apples #copyIdBtn, .theme-apples #pasteIdBtn,
    .theme-apples #sendTextBtn, .theme-apples #paperclipButton {
        background: linear-gradient(to bottom, #007aff 0%, #005bb5 100%);
        border: none;
        border-radius: 8px;
        color: #fff;
        text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        font-weight: 500;
    }
    .theme-apples .btn:hover, .theme-apples #copyIdBtn:hover, .theme-apples #pasteIdBtn:hover,
    .theme-apples #sendTextBtn:hover, .theme-apples #paperclipButton:hover {
        background: linear-gradient(to bottom, #005bb5 0%, #007aff 100%);
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        transform: translateY(1px);
    }
    .theme-apples #copyIdBtn {
        background: #e0e0e0;
        border: 1px solid #ccc;
        color: #333;
        text-shadow: none;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        font-weight: 400;
    }
    .theme-apples #copyIdBtn:hover {
        background: #d0d0d0;
    }
    .theme-apples #pasteIdBtn {
        background: #e0e0e0;
        border: 1px solid #ccc;
        color: #333;
        text-shadow: none;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        font-weight: 400;
    }
    .theme-apples #pasteIdBtn:hover {
        background: #d0d0d0;
    }
    .theme-apples #progressBarContainer {
        border: 1px solid rgba(0,0,0,0.1);
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        border-radius: 5px;
        background: #fff;
    }
    .theme-apples #progressBar {
        background: linear-gradient(90deg, #32cd32, #008000); /* Standard green for progress */
        color: #fff;
        text-shadow: 0 1px 1px rgba(0,0,0,0.2);
        border-radius: 5px;
    }
    .theme-apples #shibaText {
        border-color: #ccc;
        color: #333;
        text-shadow: none;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .theme-apples #shibaImage {
        filter: none; /* Remove pixel filter for cleaner look */
    }
    .theme-apples #paperclipButton {
        background: #e0e0e0;
        border: 1px solid #ccc;
        border-radius: 50%; /* Make it round */
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        color: #333;
        font-size: 40px; /* Slightly smaller emoji */
        width: 60px; /* Make it round */
        height: 60px; /* Make it round */
    }
    .theme-apples #paperclipButton:hover {
        background: #d0d0d0;
        transform: scale(1.05); /* Gentle scale */
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .theme-apples #paperclipText {
        color: #666;
        text-shadow: none;
        border: none;
        background: none;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    }
    .theme-apples #dropZoneOverlay {
        border: 4px dashed #007aff;
        background: rgba(255, 255, 255, 0.7);
        color: #007aff;
        text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        border-radius: 20px;
    }


    /* Media queries for responsiveness */
    @media (max-width: 768px) {
      .title { font-size: 14px; }
      .welcome { font-size: 10px; }
      .code-input, .message { font-size: 14px; }
      .btn, #pasteIdBtn { font-size: 12px; padding: 8px 15px; } /* Apply to paste btn too */
      .status-message { top: 70px; font-size: 8px; }
      .splash-text { font-size: 16px; }
      .splash-subtext { font-size: 10px; }
      .how-to-use { font-size: 9px; padding: 15px; max-width: 300px; }
      .how-to-use h3 { font-size: 12px; }
      .how-to-use li { margin-bottom: 8px; }
      .how-to-use p { font-size: 8px; }
      #readyButton { padding: 10px 20px; font-size: 14px; }
      #myPeerId { font-size: 14px; }
      #shibaImage { width: 48px; height: 48px; }
      #shibaText { font-size: 8px; }
      .footer { font-size: 8px; }
      .social-links a { font-size: 10px; }
      #paperclipButton {
        font-size: 36px;
        padding: 8px;
        width: 52px; /* Adjusted for smaller screens */
        height: 52px; /* Adjusted for smaller screens */
      }
      .theme-apples #paperclipButton {
          width: 50px;
          height: 50px;
          font-size: 30px;
      }
      #paperclipText {
        font-size: 8px;
      }
      #paperclipButtonContainer {
        top: 30%; /* Slightly higher on mobile */
      }
      #textTransferContainer {
        bottom: 80px; /* Adjust for smaller footer and progress bar */
        width: 95%; /* Make it slightly wider on mobile */
      }
      #textInput, #receivedTextDisplay {
        font-size: 10px;
        height: 60px;
      }
      #sendTextBtn {
        font-size: 10px;
        padding: 6px 10px;
      }
      .theme-selector-container label {
        font-size: 10px;
      }
      #themeSelect {
        font-size: 10px;
        padding: 6px 10px;
      }
    }

  </style>
</head>
<body>

  <div id="splashScreen">
    <div class="splash-text">
      Welcome to Sebit P2P File Transfer!
    </div>
    <div class="splash-subtext">
      This is still in Alpha and Work in Progress but focused with privacy in mind.
    </div>
    <div class="how-to-use">
        <h3>Quick How-To:</h3>
        <ul>
            <li>1. Open on two devices to begin.</li>
            <li>2. One person shares their Unique ID.</li>
            <li>3. The other person enters that ID or uses the **Paste ID** button and clicks "Connect".</li>
            <li>4. Once connected, drag & drop files or folders anywhere on the page to send.</li>
            <li>5. Or, click the 📎 icon to browse and attach files!</li>
            <li>6. **NEW!** Send text messages for easy copy & paste.</li>
        </ul>
        <p>(Connection status will be displayed below.)</p>
    </div>

    <div class="theme-selector-container">
      <label for="themeSelect">Choose your theme:</label>
      <select id="themeSelect">
        <option value="vaporwave" selected>Vaporwave (Default)</option>
        <option value="computer-guy">Computer Guy (Matrix)</option>
        <option value="gas">Gas</option>
        <option value="neon">Neon (Black/Orange)</option>
        <option value="nostalgia-xp">Nostalgia (Windows XP)</option>
        <option value="nostalgia-vista">Nostalgia (Windows Vista)</option>
        <option value="a-box-720">A Box 720 (Xbox 360)</option>
        <option value="the-young-scrolls">The Young Scrolls (Oblivion)</option>
        <option value="apples">Apples (macOS)</option>
      </select>
    </div>

    <button id="readyButton">Ready!</button>
  </div>

  <div class="title">🌊 Sebit Lan Share 🌊</div>
  <div class="welcome">Welcome to Seb P2P LAN sharer!</div>
  <div class="status-message" id="statusMessage">Connecting to signaling server...</div>

  <div class="overlay" id="roomOverlay">
    <div class="message">
        <p>Your unique ID:</p>
        <div class="id-display">
            <span id="myPeerId"></span>
            <button id="copyIdBtn" class="btn">Copy ID</button>
        </div>
        <p>Share this ID for others to connect, or enter an ID below:</p>
    </div>
    <input type="text" id="roomCodeInput" class="code-input" placeholder="Enter peer ID to connect" maxlength="36">
    <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px;">
        <button id="connectBtn" class="btn">Connect</button>
        <button id="pasteIdBtn" class="btn">Paste ID</button>
        <button id="newIdBtn" class="btn">Generate New ID</button>
    </div>
  </div>

  <div id="dropZoneOverlay">
      <div class="message">
          <p>Drag and drop your files or folders here to send!</p>
          <p class="small-text">(Files will be sent to your connected device)</p>
      </div>
  </div>

  <div id="progressBarContainer">
      <div id="progressBar">0%</div>
  </div>

  <div id="shibaContainer">
    <img id="shibaImage" src="shiba.gif" alt="8-bit Shiba Inu">
    <div id="shibaText">This Shiba Inu is your other device!</div>
  </div>

  <div id="paperclipButtonContainer">
    <button id="paperclipButton">
      📎
    </button>
    <div id="paperclipText">Drag & drop files or click to attach</div>
  </div>

  <div id="textTransferContainer">
    <textarea id="textInput" placeholder="Type message to send..."></textarea>
    <button id="sendTextBtn">Send Text</button>
    <div id="receivedTextDisplay" title="Click to copy received text"></div>
  </div>

  <div class="footer">
    Created by Rawxia - Privacy in mind
    <div class="social-links">
        <a href="https://www.instagram.com/sebulique/" target="_blank" rel="noopener noreferrer">Instagram</a>
        <a href="https://www.youtube.com/@6_LN" target="_blank" rel="noopener noreferrer">YouTube</a>
    </div>
  </div>
  <input type="file" id="fileInput" multiple webkitdirectory directory />

  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

  <script>
    const PEER_ID_EXPECTED_LENGTH = 36;
    const CHUNK_SIZE = 16 * 1024;

    let peer;
    const peerConnections = {};
    let currentRoomId = '';
    let isFileBeingSent = false;
    let totalFilesToSend = 0;
    let sentFilesCount = 0;

    const myPeerIdSpan = document.getElementById('myPeerId');
    const roomCodeInput = document.getElementById('roomCodeInput');
    const connectBtn = document.getElementById('connectBtn');
    const pasteIdBtn = document.getElementById('pasteIdBtn');
    const newIdBtn = document.getElementById('newIdBtn');
    const roomOverlay = document.getElementById('roomOverlay');
    const statusMessage = document.getElementById('statusMessage');
    const splashScreen = document.getElementById('splashScreen');
    const dropZoneOverlay = document.getElementById('dropZoneOverlay');
    const progressBarContainer = document.getElementById('progressBarContainer');
    const progressBar = document.getElementById('progressBar');
    const shibaContainer = document.getElementById('shibaContainer');
    const shibaText = document.getElementById('shibaText');
    const copyIdBtn = document.getElementById('copyIdBtn');
    const readyButton = document.getElementById('readyButton');
    const paperclipButtonContainer = document.getElementById('paperclipButtonContainer');
    const paperclipButton = document.getElementById('paperclipButton');
    const fileInput = document.getElementById('fileInput');
    const textTransferContainer = document.getElementById('textTransferContainer');
    const textInput = document.getElementById('textInput');
    const sendTextBtn = document.getElementById('sendTextBtn');
    const receivedTextDisplay = document.getElementById('receivedTextDisplay');

    // New theme elements
    const themeSelect = document.getElementById('themeSelect');
    const body = document.body;
    const THEMES = ['vaporwave', 'computer-guy', 'gas', 'neon', 'nostalgia-xp', 'nostalgia-vista', 'a-box-720', 'the-young-scrolls', 'apples'];

    roomCodeInput.setAttribute('maxlength', PEER_ID_EXPECTED_LENGTH);

    function updateStatus(message, color = '#0f0') {
        statusMessage.textContent = message;
        statusMessage.style.color = color;
    }

    function hideSplashScreen() {
        splashScreen.classList.add('fade-out');
        setTimeout(() => {
            splashScreen.style.display = 'none';
        }, 2000);
    }

    // Function to apply selected theme
    function applyTheme(themeName) {
        // Remove all theme classes
        THEMES.forEach(theme => body.classList.remove(`theme-${theme}`));
        // Add the selected theme class, unless it's the default 'vaporwave' which uses base styles
        if (themeName && themeName !== 'vaporwave') {
            body.classList.add(`theme-${themeName}`);
        }
        localStorage.setItem('selectedTheme', themeName); // Save preference
    }

    // Function to load theme on startup
    function loadTheme() {
        const savedTheme = localStorage.getItem('selectedTheme');
        if (savedTheme && THEMES.includes(savedTheme)) {
            themeSelect.value = savedTheme; // Set dropdown to saved theme
            applyTheme(savedTheme);
        } else {
            // Default to vaporwave if no saved theme or invalid theme
            themeSelect.value = 'vaporwave';
            applyTheme('vaporwave');
        }
    }


    // Function to initialize PeerJS connection
    function initializePeer(id = null) {
      updateStatus("Connecting to signaling server...");
      // Destroy existing peer if it exists and is not already destroyed
      if (peer && !peer.destroyed) {
          peer.destroy();
      }

      // Create a new Peer instance
      peer = new Peer(id, {
          config: {
              iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
          }
      });

      // Event: PeerJS connection opened
      peer.on('open', (id) => {
        currentRoomId = id;
        myPeerIdSpan.textContent = id;
        roomOverlay.style.display = 'flex';
        updateStatus(`Connected! Your ID: ${id}. Waiting for connection...`);
        console.log('My peer ID is: ' + id);
      });

      // Event: Incoming connection from another peer
      peer.on('connection', (conn) => {
        console.log(`Incoming connection from: ${conn.peer}`);
        setupDataChannel(conn, conn.peer);
        addBubble(conn.peer);
        updateStatus(`Connected to ${conn.peer}!`, '#ffdd00');
        roomOverlay.style.display = 'none'; // Hide the ID input overlay
        shibaContainer.classList.add('active'); // Show Shiba
        shibaText.textContent = `This Shiba Inu is your other device (${conn.peer.substring(0,8)}...)!`;
        paperclipButtonContainer.style.display = 'flex'; // Show the file transfer button
        textTransferContainer.style.display = 'flex'; // Show text transfer container
      });

      // Event: PeerJS error
      peer.on('error', (err) => {
        console.error('PeerJS error:', err);
        updateStatus(`Error: ${err.message}. Please refresh or try a new ID.`, '#f00');
        // Attempt to destroy peer only if not already destroyed to prevent errors
        if (peer && !peer.destroyed) {
            peer.destroy();
        }
        // Try to reinitialize after a short delay
        setTimeout(() => initializePeer(), 1000);
      });

      // Event: PeerJS disconnected from signaling server
      peer.on('disconnected', () => {
          console.log('PeerJS disconnected from signaling server.');
          updateStatus('Disconnected. Trying to reconnect...', '#f90');
          // Only attempt reconnect if peer is not destroyed
          if (!peer.destroyed) {
              peer.reconnect();
          }
          // Hide connected UI elements
          shibaContainer.classList.remove('active');
          roomOverlay.style.display = 'flex';
          paperclipButtonContainer.style.display = 'none';
          textTransferContainer.style.display = 'none';
      });
    }

    // Function to connect to a remote peer
    function connectToPeer(remoteId) {
        if (!peer || !peer.open) {
            updateStatus('PeerJS not ready. Please wait or refresh.', '#f00');
            return;
        }

        // Special condition for "testtestseb" to allow self-connection
        if (remoteId === currentRoomId && remoteId !== "testtestseb") {
            updateStatus('Cannot connect to yourself!', '#f00');
            return;
        }
        // Validate ID length unless it's the special test ID
        if (remoteId.length !== PEER_ID_EXPECTED_LENGTH && remoteId !== "testtestseb") {
            updateStatus(`Please enter a valid Peer ID of ${PEER_ID_EXPECTED_LENGTH} characters.`, '#f00');
            return;
        }

        updateStatus(`Attempting to connect to ${remoteId}...`);
        console.log(`Attempting to connect to peer: ${remoteId}`);

        // Create a new data connection
        const conn = peer.connect(remoteId);
        // Store the connection for later use
        peerConnections[remoteId] = conn;

        // Event: DataChannel opened (connection established)
        conn.on('open', () => {
            console.log(`DataChannel opened with ${remoteId}`);
            setupDataChannel(conn, remoteId); // Setup handlers for this specific connection
            addBubble(remoteId); // Add a visual bubble for the connected peer
            updateStatus(`Connected to ${remoteId}!`, '#ffdd00');
            roomOverlay.style.display = 'none'; // Hide the ID input overlay
            shibaContainer.classList.add('active'); // Show Shiba
            shibaText.textContent = `This Shiba Inu is your other device (${conn.peer.substring(0,8)}...)!`;
            paperclipButtonContainer.style.display = 'flex'; // Show the file transfer button
            textTransferContainer.style.display = 'flex'; // Show text transfer container
        });

        // Event: Connection error
        conn.on('error', (err) => {
            console.error(`Connection error with ${remoteId}:`, err);
            updateStatus(`Failed to connect to ${remoteId}: ${err.message}`, '#f00');
            delete peerConnections[remoteId]; // Remove connection from our list
            removeBubble(remoteId); // Remove the visual bubble
            // Restore UI for entering ID
            shibaContainer.classList.remove('active');
            roomOverlay.style.display = 'flex';
            paperclipButtonContainer.style.display = 'none';
            textTransferContainer.style.display = 'none';
        });

        // Event: Connection closed
        conn.on('close', () => {
            console.log(`Connection to ${remoteId} closed.`);
            updateStatus(`Disconnected from ${remoteId}.`, '#f90');
            delete peerConnections[remoteId];
            removeBubble(remoteId);
            shibaContainer.classList.remove('active');
            roomOverlay.style.display = 'flex';
            // If no active connections, hide transfer buttons
            if (Object.keys(peerConnections).length === 0) {
                paperclipButtonContainer.style.display = 'none';
                textTransferContainer.style.display = 'none';
            }
        });
    }

    // Function to set up data channel event listeners
    function setupDataChannel(conn, remoteId) {
      peerConnections[remoteId] = conn; // Ensure connection is stored

      let receivingQueue = [];
      let currentReceivingFile = null;
      let receivedBufferChunks = [];
      let receivedBytesForCurrentFile = 0;
      let totalReceivedFiles = 0;

      conn.on('data', async (data) => {
        if (typeof data === 'string') {
          try {
            const msg = JSON.parse(data);
            if (msg.type === 'file-metadata') {
                // Initialize new file transfer
                receivingQueue.push({
                    filename: msg.filename,
                    fileSize: msg.fileSize,
                    relativePath: msg.relativePath || msg.filename,
                    buffer: [],
                    receivedSize: 0,
                    status: 'receiving'
                });
                if (!currentReceivingFile) { // If no file is currently being received, start this one
                    currentReceivingFile = receivingQueue.shift();
                    receivedBufferChunks = [];
                    receivedBytesForCurrentFile = 0;
                    updateProgressBar(0, `Receiving '${currentReceivingFile.relativePath}'...`);
                    console.log(`Receiving file: ${currentReceivingFile.relativePath} (${currentReceivingFile.fileSize} bytes)`);
                }
            } else if (msg.type === 'file-chunk-complete') {
              // File transfer is complete, process the received file
              if (currentReceivingFile && receivedBytesForCurrentFile >= currentReceivingFile.fileSize) {
                const blob = new Blob(receivedBufferChunks);

                // Attempt to use File System Access API first, then fallback to traditional download
                if (window.showDirectoryPicker) {
                    try {
                        const dirHandle = await getDownloadDirectoryHandle();
                        await saveFileToDirectory(dirHandle, currentReceivingFile.relativePath, blob);
                        updateStatus(`📁 Received '${currentReceivingFile.relativePath}' to specified folder!`);
                    } catch (e) {
                        console.error("Error saving file via File System Access API:", e);
                        downloadBlobAsFile(blob, currentReceivingFile.relativePath);
                        updateStatus(`📁 Received '${currentReceivingFile.relativePath}' via traditional download!`);
                    }
                } else {
                    downloadBlobAsFile(blob, currentReceivingFile.relativePath);
                    updateStatus(`📁 Received '${currentReceivingFile.relativePath}'!`);
                }

                console.log(`Successfully received and processed ${currentReceivingFile.relativePath}`);
                totalReceivedFiles++;

                // If more files in queue, start next one
                if (receivingQueue.length > 0) {
                    currentReceivingFile = receivingQueue.shift();
                    receivedBufferChunks = [];
                    receivedBytesForCurrentFile = 0;
                    updateProgressBar(0, `Receiving '${currentReceivingFile.relativePath}'...`);
                    console.log(`Starting next file: ${currentReceivingFile.relativePath}`);
                } else {
                    // All files received, reset state
                    currentReceivingFile = null;
                    hideProgressBar();
                    triggerConfetti();
                    updateStatus(`Transfer complete safe and sound! Received ${totalReceivedFiles} files.`, '#00ffcc');
                    console.log(`All ${totalReceivedFiles} files received.`);
                    totalReceivedFiles = 0;
                }
              }
            } else if (msg.type === 'text-message') { // Handle incoming text messages
                console.log(`Received text message from ${remoteId}:`, msg.text);
                receivedTextDisplay.textContent = `Received from ${remoteId.substring(0, 8)}...\n\n${msg.text}`;
                receivedTextDisplay.style.display = 'block'; // Show the display area
                updateStatus(`New text message received from ${remoteId.substring(0, 8)}...! Click message to copy.`, '#ffdd00');
            }
          } catch (e) {
            // This catch block handles cases where the string data is not valid JSON
            console.warn("Received non-JSON string or malformed JSON:", data);
            // If it's not JSON, it could be a file chunk for the current file
            if (currentReceivingFile) {
                currentReceivingFile.buffer.push(data);
                receivedBufferChunks.push(data);
                currentReceivingFile.receivedSize += data.byteLength || data.size;
                receivedBytesForCurrentFile += data.byteLength || data.size;

                const percentage = (receivedBytesForCurrentFile / currentReceivingFile.fileSize) * 100;
                updateProgressBar(percentage, `Receiving '${currentReceivingFile.relativePath}': ${percentage.toFixed(0)}%`);
            }
          }
        } else {
          // Data is a Blob or ArrayBuffer (binary data), likely a file chunk
          if (currentReceivingFile) {
            currentReceivingFile.buffer.push(data);
            receivedBufferChunks.push(data);
            currentReceivingFile.receivedSize += data.byteLength || data.size;
            receivedBytesForCurrentFile += data.byteLength || data.size;

            const percentage = (receivedBytesForCurrentFile / currentReceivingFile.fileSize) * 100;
            updateProgressBar(percentage, `Receiving '${currentReceivingFile.relativePath}': ${percentage.toFixed(0)}%`);
          }
        }
      });
      // Connection closed event for the specific data channel
      conn.on('close', () => {
        console.log('Connection closed for:', remoteId);
        updateStatus(`Disconnected from ${remoteId}.`, '#f90');
        removeBubble(remoteId);
        hideProgressBar();
        isFileBeingSent = false;
        shibaContainer.classList.remove('active');
        roomOverlay.style.display = 'flex';
        receivedTextDisplay.style.display = 'none'; // Hide text display
        receivedTextDisplay.textContent = ''; // Clear text
        if (Object.keys(peerConnections).length === 0) {
            paperclipButtonContainer.style.display = 'none';
            textTransferContainer.style.display = 'none';
        }
      });
      // Error event for the specific data channel
      conn.on('error', (err) => {
        console.error('Data channel error for', remoteId, err);
        updateStatus(`Error with ${remoteId}'s connection.`, '#f00');
        hideProgressBar();
        isFileBeingSent = false;
        shibaContainer.classList.remove('active');
        roomOverlay.style.display = 'flex';
        receivedTextDisplay.style.display = 'none'; // Hide text display
        receivedTextDisplay.textContent = ''; // Clear text
        if (Object.keys(peerConnections).length === 0) {
            paperclipButtonContainer.style.display = 'none';
            textTransferContainer.style.display = 'none';
        }
      });
    }

    // Utility function to download a Blob as a file
    function downloadBlobAsFile(blob, filename) {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        a.click();
        URL.revokeObjectURL(a.href);
    }

    let downloadDirectoryHandle = null;

    // Function to get a directory handle for downloads (File System Access API)
    async function getDownloadDirectoryHandle() {
        if (downloadDirectoryHandle) {
            return downloadDirectoryHandle;
        }
        try {
            downloadDirectoryHandle = await window.showDirectoryPicker();
            updateStatus('Download directory selected. Files will be saved there.', '#0f0');
            return downloadDirectoryHandle;
        } catch (err) {
            console.error('User cancelled or error getting directory handle:', err);
            updateStatus('Directory selection cancelled. Files will download normally.', '#f90');
            throw err;
        }
    }

    // Function to save a file to a directory handle (File System Access API)
    async function saveFileToDirectory(dirHandle, fullPath, blob) {
        const pathParts = fullPath.split('/');
        let currentHandle = dirHandle;

        for (let i = 0; i < pathParts.length - 1; i++) {
            const dirName = pathParts[i];
            currentHandle = await currentHandle.getDirectoryHandle(dirName, { create: true });
        }

        const fileName = pathParts[pathParts.length - 1];
        const fileHandle = await currentHandle.getFileHandle(fileName, { create: true });
        const writable = await fileHandle.createWritable();
        await writable.write(blob);
        await writable.close();
    }

    // Function to send files to a connected peer
    async function sendFilesToPeer(files, conn) {
        if (!conn || !conn.open) {
            updateStatus(`Connection to ${conn.peer} is not open! Cannot send files.`, '#f00');
            console.error(`Attempted to send files to ${conn.peer}, but connection is not open.`);
            return;
        }
        if (isFileBeingSent) {
            updateStatus('A file transfer is already in progress. Please wait.', '#f00');
            return;
        }

        isFileBeingSent = true;
        totalFilesToSend = files.length;
        sentFilesCount = 0;
        let totalBytesSent = 0;
        let totalSize = files.reduce((sum, f) => sum + f.size, 0);

        updateStatus(`Preparing to send ${totalFilesToSend} file(s) to ${conn.peer}...`);
        updateProgressBar(0, `Sending file 1 of ${totalFilesToSend}...`);

        try {
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                sentFilesCount = i + 1;

                // Send file metadata first
                conn.send(JSON.stringify({
                    type: 'file-metadata',
                    filename: file.name,
                    fileSize: file.size,
                    relativePath: file.webkitRelativePath || file.name
                }));

                const reader = file.stream().getReader();
                let fileOffset = 0;

                // Stream file chunks
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) {
                        break;
                    }
                    conn.send(value); // Send the chunk
                    fileOffset += value.length;
                    totalBytesSent += value.length;

                    const overallPercentage = (totalBytesSent / totalSize) * 100;
                    updateProgressBar(overallPercentage,
                        `Sending file ${sentFilesCount} of ${totalFilesToSend}: ${file.name} - ${((fileOffset / file.size) * 100).toFixed(0)}%`);
                }

                // Small delay to ensure chunk ordering/processing on receiver
                await new Promise(resolve => setTimeout(resolve, 50));
            }

            // Signal end of file transfer
            conn.send(JSON.stringify({ type: 'file-chunk-complete' }));
            updateStatus(`📁 Sent ${totalFilesToSend} file(s) to ${conn.peer}!`);
            console.log(`Successfully sent ${totalFilesToSend} file(s).`);
            hideProgressBar();
            triggerConfetti();
            updateStatus('Transfer complete safe and sound!', '#00ffcc');

        } catch (error) {
            console.error("Error sending files:", error);
            updateStatus(`Error sending files: ${error.message}`, '#f00');
            hideProgressBar();
        } finally {
            isFileBeingSent = false;
            totalFilesToSend = 0;
            sentFilesCount = 0;
        }
    }

    const activeBubbles = {};

    // Function to add a visual bubble for a connected peer
    function addBubble(id) {
      if (activeBubbles[id]) return; // Avoid duplicate bubbles

      const b = document.createElement('div');
      b.className = 'bubble';
      b.id = `bubble-${id}`;
      b.style.left = `${Math.random() * 80 + 10}%`; // Random horizontal position
      b.style.animationDelay = `${Math.random() * 3}s`; // Random start delay
      b.style.animationDuration = `${5 + Math.random() * 5}s`; // Random animation duration

      // Add ID text to the bubble
      const idText = document.createElement('span');
      idText.textContent = id.substring(0, 8) + '...'; // Show only first 8 chars of ID
      idText.style.position = 'absolute';
      idText.style.top = '100%';
      idText.style.left = '50%';
      idText.style.transform = 'translateX(-50%)';
      idText.style.fontSize = '8px';
      idText.style.color = 'inherit'; /* Inherit color from theme */
      idText.style.textShadow = 'inherit'; /* Inherit text-shadow from theme */
      idText.style.whiteSpace = 'nowrap';
      b.appendChild(idText);

      b.onclick = () => {
        updateStatus(`Connected to ${id}. Drag & Drop file(s) or folder(s) anywhere to send.`);
      };
      document.body.appendChild(b);
      activeBubbles[id] = b;
    }

    // Function to remove a peer's visual bubble
    function removeBubble(id) {
        if (activeBubbles[id]) {
            activeBubbles[id].remove();
            delete activeBubbles[id];
        }
    }

    // Functions for progress bar display
    function updateProgressBar(percentage, text) {
        progressBarContainer.classList.add('active');
        progressBar.style.width = `${percentage}%`;
        progressBar.textContent = text;
    }

    function hideProgressBar() {
        progressBarContainer.classList.remove('active');
        progressBar.style.width = '0%';
        progressBar.textContent = '0%';
    }

    // Function to trigger confetti animation
    function triggerConfetti() {
        const numConfetti = 50;
        for (let i = 0; i < numConfetti; i++) {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.left = `${Math.random() * 100}vw`;
            confetti.style.setProperty('--x', `${Math.random() * 200 - 100}px`);
            confetti.style.setProperty('--y', `${Math.random() * -100}px`);
            confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
            document.body.appendChild(confetti);

            confetti.addEventListener('animationend', () => {
                confetti.remove();
            });
        }
    }

    let dragCounter = 0;
    let isMobileUploadActive = false; // Flag to manage mobile file selection vs. drag/drop

    // Drag and Drop event listeners
    document.body.addEventListener('dragenter', (e) => {
        e.preventDefault();
        e.stopPropagation();
        if (isMobileUploadActive) return; // Ignore if mobile upload flow is active

        dragCounter++;
        if (Object.keys(peerConnections).length > 0) {
            dropZoneOverlay.classList.add('active');
        } else {
            updateStatus("Connect to a peer first to drag and drop files!", '#f00');
        }
    });

    document.body.addEventListener('dragleave', (e) => {
        e.preventDefault();
        e.stopPropagation();
        if (isMobileUploadActive) return;

        dragCounter--;
        if (dragCounter === 0) {
            dropZoneOverlay.classList.remove('active');
        }
    });

    document.body.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.stopPropagation();
        if (isMobileUploadActive) return;

        e.dataTransfer.dropEffect = 'copy'; // Indicate that data will be copied
        if (!dropZoneOverlay.classList.contains('active') && Object.keys(peerConnections).length > 0) {
            dropZoneOverlay.classList.add('active');
        }
    });

    document.body.addEventListener('drop', async (e) => {
        e.preventDefault();
        e.stopPropagation();
        if (isMobileUploadActive) return;

        dragCounter = 0; // Reset drag counter
        dropZoneOverlay.classList.remove('active'); // Hide drop zone overlay

        if (Object.keys(peerConnections).length === 0) {
            updateStatus("No active connections to send files to. Connect to a peer first!", '#f00');
            return;
        }

        const files = [];
        if (e.dataTransfer.items) {
            // Use DataTransferItemList interface for better directory handling
            for (let i = 0; i < e.dataTransfer.items.length; i++) {
                const item = e.dataTransfer.items[i];
                if (item.kind === 'file') {
                    const entry = item.webkitGetAsEntry(); // Get FileSystemEntry
                    if (entry) {
                        await getFilesFromEntry(entry, files); // Recursively get files from folders
                    }
                }
            }
        } else {
            // Fallback for browsers that don't support DataTransferItemList (or webkitGetAsEntry)
            Array.from(e.dataTransfer.files).forEach(file => files.push(file));
        }

        if (files.length > 0) {
            // Send files to all active connections
            for (const peerId in peerConnections) {
                const conn = peerConnections[peerId];
                if (conn && conn.open) {
                    await sendFilesToPeer(files, conn);
                } else {
                    updateStatus(`Skipping ${peerId}: connection not open.`, '#f90');
                }
            }
        } else {
            updateStatus("No files were dropped.", '#f00');
        }
    });

    // Recursive function to get files from dropped items (handles folders)
    async function getFilesFromEntry(entry, fileList, path = '') {
        if (entry.isFile) {
            await new Promise(resolve => {
                entry.file(file => {
                    file.webkitRelativePath = path + file.name; // Preserve folder structure
                    fileList.push(file);
                    resolve();
                });
            });
        } else if (entry.isDirectory) {
            const directoryReader = entry.createReader();
            await new Promise(resolve => {
                directoryReader.readEntries(async (entries) => {
                    for (const subEntry of entries) {
                        await getFilesFromEntry(subEntry, fileList, path + entry.name + '/');
                    }
                    resolve();
                });
            });
        }
    }

    // Event listeners for UI buttons
    connectBtn.addEventListener('click', () => {
      const remoteId = roomCodeInput.value.trim();
      if (remoteId) {
        connectToPeer(remoteId);
      } else {
        updateStatus('Please enter a peer ID.', '#f00');
      }
    });

    // New: Paste ID button functionality
    pasteIdBtn.addEventListener('click', async () => {
        try {
            const text = await navigator.clipboard.readText();
            roomCodeInput.value = text.trim();
            updateStatus('ID pasted from clipboard. Click Connect to proceed.', '#00ffcc');
        } catch (err) {
            console.error('Failed to read clipboard contents: ', err);
            updateStatus('Failed to paste ID. Please paste manually.', '#f00');
        }
    });

    newIdBtn.addEventListener('click', () => {
        if (peer && !peer.destroyed) {
            peer.destroy();
        }
        initializePeer();
    });

    copyIdBtn.addEventListener('click', async () => {
        const idToCopy = myPeerIdSpan.textContent;
        try {
            await navigator.clipboard.writeText(idToCopy);
            copyIdBtn.textContent = 'Copied!';
            copyIdBtn.style.backgroundColor = '#00cc66';
            copyIdBtn.style.borderColor = '#009944';
            setTimeout(() => {
                copyIdBtn.textContent = 'Copy ID';
                copyIdBtn.style.backgroundColor = '#00aaff';
                copyIdBtn.style.borderColor = '#0077cc';
            }, 1500);
        } catch (err) {
            console.error('Failed to copy ID: ', err);
            updateStatus('Failed to copy ID. Please copy manually.', '#f00');
            copyIdBtn.textContent = 'Failed!';
            copyIdBtn.style.backgroundColor = '#cc0000';
            copyIdBtn.style.borderColor = '#990000';
            setTimeout(() => {
                copyIdBtn.textContent = 'Copy ID';
                copyIdBtn.style.backgroundColor = '#00aaff';
                copyIdBtn.style.borderColor = '#0077cc';
            }, 2000);
        }
    });

    readyButton.addEventListener('click', () => {
        hideSplashScreen();
        setTimeout(() => {
            initializePeer(); // Initialize PeerJS only after splash screen hides
        }, 500);
    });

    paperclipButton.addEventListener('click', () => {
        if (Object.keys(peerConnections).length > 0) {
            isMobileUploadActive = true; // Set flag for mobile upload flow
            fileInput.click(); // Trigger hidden file input click
        } else {
            updateStatus("Connect to a peer first to send files!", '#f00');
        }
    });

    fileInput.addEventListener('change', async (e) => {
        isMobileUploadActive = false; // Reset flag
        const selectedFiles = Array.from(e.target.files);

        if (selectedFiles.length > 0) {
            for (const peerId in peerConnections) {
                const conn = peerConnections[peerId];
                if (conn && conn.open) {
                    await sendFilesToPeer(selectedFiles, conn);
                } else {
                    updateStatus(`Skipping ${peerId}: connection not open.`, '#f90');
                }
            }
        } else {
            updateStatus("No files selected.", '#f00');
        }
        fileInput.value = ''; // Clear file input so same file can be selected again
    });

    // Send text message event listener
    sendTextBtn.addEventListener('click', () => {
        const messageText = textInput.value.trim();
        if (messageText === '') {
            updateStatus('Please type a message to send.', '#f00');
            return;
        }

        if (Object.keys(peerConnections).length === 0) {
            updateStatus("No active connections to send text to. Connect to a peer first!", '#f00');
            return;
        }

        for (const peerId in peerConnections) {
            const conn = peerConnections[peerId];
            if (conn && conn.open) {
                try {
                    conn.send(JSON.stringify({
                        type: 'text-message',
                        text: messageText
                    }));
                    updateStatus(`Text message sent to ${peerId.substring(0, 8)}...`, '#00ffcc');
                    textInput.value = ''; // Clear input after sending
                } catch (error) {
                    console.error(`Error sending text to ${peerId}:`, error);
                    updateStatus(`Failed to send text to ${peerId.substring(0, 8)}: ${error.message}`, '#f00');
                }
            } else {
                updateStatus(`Skipping ${peerId}: connection not open.`, '#f90');
            }
        }
    });

    // Copy received text on click event listener
    receivedTextDisplay.addEventListener('click', async () => {
        // Remove the "Received from..." header before copying
        const textToCopy = receivedTextDisplay.textContent.replace(/^Received from [a-zA-Z0-9]+\.\.\.\n\n/, '');
        if (textToCopy) {
            try {
                await navigator.clipboard.writeText(textToCopy);
                updateStatus('Received text copied to clipboard!', '#00ffcc');
            } catch (err) {
                console.error('Failed to copy text: ', err);
                updateStatus('Failed to copy text. Please copy manually.', '#f00');
            }
        }
    });

    // Theme selection change listener
    themeSelect.addEventListener('change', (event) => {
        applyTheme(event.target.value);
    });

    // Initial load handler
    window.onload = () => {
        loadTheme(); // Load saved theme first
        splashScreen.style.display = 'flex';
    };
  </script>
</body>
</html>
